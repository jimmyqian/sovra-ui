#!/bin/bash
set -e

# Deployment script for {{ app_name }}
# This script is generated by Ansible and can be run manually or via CI/CD

REPO_URL="{{ git_repo_url }}"
BRANCH="{{ git_branch }}"
DEPLOY_DIR="{{ app_root }}"
TIMESTAMP=$(date +%Y-%m-%d-%H%M%S)
RELEASE_DIR="$DEPLOY_DIR/releases/$TIMESTAMP"

echo "==> Starting deployment at $TIMESTAMP"

# Clone repository
echo "==> Cloning repository from $REPO_URL (branch: $BRANCH)"
git clone --depth 1 --branch "$BRANCH" "$REPO_URL" "$RELEASE_DIR"

# Navigate to release directory
cd "$RELEASE_DIR"

# Install dependencies
echo "==> Installing dependencies"
npm ci --production=false

# Build application
echo "==> Building application"
npm run build

# Verify build output
if [ ! -d "$RELEASE_DIR/dist" ]; then
    echo "ERROR: Build failed - dist directory not found"
    exit 1
fi

# Update symlink
echo "==> Updating current symlink"
ln -nfs "$RELEASE_DIR" "$DEPLOY_DIR/current"

# Test nginx configuration
echo "==> Testing nginx configuration"
sudo nginx -t

# Reload nginx
echo "==> Reloading nginx"
sudo systemctl reload nginx

# Clean up old releases (keep last 5)
echo "==> Cleaning up old releases (keeping last 5)"
cd "$DEPLOY_DIR/releases"
ls -t | tail -n +6 | xargs -r rm -rf

echo "==> Deployment complete: $TIMESTAMP"
echo "==> Current release: $RELEASE_DIR"
echo "==> Application is now live at https://{{ domain_name }}"
